document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".custom-video").forEach((e=>{const t=e.parentElement.querySelector(".play-button");e.addEventListener("ended",(()=>{e.pause(),t.classList.remove("d-none")})),t.addEventListener("click",(()=>{e.currentTime===e.duration&&(e.currentTime=0),e.play(),t.classList.add("d-none")})),e.addEventListener("click",(()=>{e.paused||(e.pause(),t.classList.remove("d-none"))})),e.addEventListener("play",(()=>{t.classList.add("d-none")})),e.pause(),t.classList.remove("d-none")}))})),document.addEventListener("DOMContentLoaded",(()=>{class e{constructor(e){this.mainVideo=e,this.currentAudioElement=null,this.play_button_html='<svg class="bi bi-play-fill" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="color: var(--bs-body-bg); font-size:22px;"> <path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"></path></svg>',this.pause_button_html='<svg class="bi bi-pause-fill" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" style="color: var(--bs-body-bg); font-size:22px;"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5m5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5"></path></svg>'}async playMedia(e){try{const t=e.closest(".audio-container"),n=this.mainVideo.closest(".video-container"),o=t.closest(".video-audio-section");if(!o||!o.contains(n))return void console.error("Audio and video are not in the same section");if(document.querySelectorAll(".video-audio-section").forEach((e=>{if(e!==o){const t=e.querySelector("video"),n=e.querySelectorAll(".audio-player");t&&t.pause(),n.forEach((e=>{e.pause(),this.updatePlayButton(e,!1)}))}})),this.currentAudioElement&&this.currentAudioElement===e)if(e.paused){const t=e.currentTime;this.mainVideo.currentTime=t;try{await this.mainVideo.play(),await e.play()}catch(e){console.error("Playback error:",e)}this.updatePlayButton(e,!0)}else this.mainVideo.pause(),e.pause(),this.updatePlayButton(e,!1),this.currentAudioElement=null,this.currentVideoElement=null;else{this.currentAudioElement&&(this.currentAudioElement.pause(),this.updatePlayButton(this.currentAudioElement,!1)),this.mainVideo.muted=!1;const t=e.currentTime;this.mainVideo.currentTime=t;try{await this.mainVideo.play()}catch(e){console.error("Video play error:",e)}try{await e.play()}catch(e){console.error("Audio play error:",e)}this.updatePlayButton(e,!0),this.currentAudioElement=e,this.currentVideoElement=this.mainVideo}}catch(e){console.error("Synchronization error:",e)}}updatePlayButton(e,t){const n=e.closest(".audio-container").querySelector(".play-button2");n&&(n.innerHTML=t?this.pause_button_html:this.play_button_html)}resetMedia(e){const t=e.closest(".audio-container").querySelector(".playback-line");e.currentTime=0,this.mainVideo.currentTime=0,this.mainVideo.pause(),e.pause(),t&&(t.style.left="0%"),this.updatePlayButton(e,!1),this.currentAudioElement=null}seekTo(e,t){const n=t*e.duration;e.currentTime=n,this.mainVideo.currentTime=n;const o=e.closest(".audio-container").querySelector(".playback-line");o&&(o.style.transition="none",o.style.left=100*t+"%",requestAnimationFrame((()=>{o.style.transition="left 0.1s linear"})))}updateAudioSource(e,t){const n=e.closest(".audio-container"),o=e.querySelector("source").src,i=n.querySelector(".spectrogram-wrapper img"),a=n.querySelector(".play-button2"),r=document.querySelector(".video-container video");let s,c;const l=o.match(/(.+?)(_text|_gtrms|_nocavp)?\.wav$/i),d=l?l[1]:o.replace(".wav","");switch(t){case"audio":s=`${d}.wav`,c=`${d}.png`;break;case"text":s=`${d}_text.wav`,c=`${d}_text.png`;break;case"GT RMS":s=`${d}_gtrms.wav`,c=`${d}_gtrms.png`;break;case"No CAVP":s=`${d}_nocavp.wav`,c=`${d}_nocavp.png`;break;default:return}e.querySelector("source").src=s,i&&(i.src=c),e.pause(),e.currentTime=0,r&&(r.pause(),r.currentTime=0),a&&(a.innerHTML=this.play_button_html),e.load();const u=n.querySelector(".playback-line");u&&(u.style.left="0%");n.querySelectorAll(".modality-btn").forEach((e=>{e.classList.remove("active"),e.textContent===t&&e.classList.add("active")}))}setupAudioContainer(e,t,n){const o=t.querySelector(".audio-player"),i=t.querySelector(".spectrogram-wrapper"),a=t.querySelector(".playback-line"),r=document.createElement("div");r.classList.add("row","align-items-center","mb-2");const s=document.createElement("div");s.classList.add("col-auto","me-auto");const c=document.createElement("h6");c.classList.add("audio-title","m-0");const l=t.dataset.title||"Audio Track";c.textContent=l,s.appendChild(c);const d=document.createElement("div");if(d.classList.add("col-auto"),"GT"!==l){const e=document.createElement("div");e.classList.add("modality-buttons");const i=(t.dataset.modalities||"").split(",").map((e=>e.trim())).filter(Boolean),a=["audio","text","GT RMS","No CAVP"];let r=null;if(i.length>0)a.forEach((t=>{if("audio"===t||i.includes(t)){const i=document.createElement("button");i.textContent=t,i.classList.add("btn","btn-sm","btn-outline-secondary","modality-btn","me-1"),null===r&&(r=t,i.classList.add("active")),i.addEventListener("click",(()=>{n.updateAudioSource(o,t)})),e.appendChild(i)}})),d.appendChild(e);else{const e=document.createElement("button");e.textContent="No cond.",e.classList.add("btn","btn-sm","btn-outline-secondary","modality-btn","me-1","active"),e.disabled=!0,d.appendChild(e)}}r.appendChild(s),d.children.length>0&&r.appendChild(d),t.insertBefore(r,i),o.removeAttribute("controls"),o.addEventListener("timeupdate",(()=>{a&&requestAnimationFrame((()=>{const e=o.currentTime/o.duration;a.style.left=100*e+"%"}))})),i.addEventListener("click",(e=>{const t=i.getBoundingClientRect(),a=(e.clientX-t.left)/t.width;n.seekTo(o,a)}));const u=document.createElement("button");u.innerHTML="▶️",u.classList.add("btn","btn-primary","play-button2","mb-2"),t.appendChild(u),u.addEventListener("click",(()=>{n.playMedia(o)})),o.addEventListener("ended",(()=>{n.resetMedia(o)}));const m="GT"===l?"audio":t.dataset.modalities?t.dataset.modalities.split(",")[0].trim():"audio";n.updateAudioSource(o,m)}setupAudioContainers(t){const n=t.querySelectorAll(".audio-container"),o=new e(t.querySelector("video"));n.forEach((e=>{this.setupAudioContainer(t,e,o)}))}}document.querySelectorAll(".video-audio-section").forEach((t=>{const n=new e(t.querySelector("video"));n.setupAudioContainers(t),t.querySelector("video").addEventListener("ended",(()=>{t.querySelectorAll(".audio-container .audio-player").forEach((e=>{n.resetMedia(e)}))}))})),window.addEventListener("scroll",(function(){document.querySelectorAll(".video-container").forEach((e=>{e.closest(".video-audio-section").getBoundingClientRect().bottom<=window.innerHeight?e.classList.add("slide-out"):e.classList.remove("slide-out")}))}))}));